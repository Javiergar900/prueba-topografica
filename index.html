<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chascom√∫s Rural - Seguridad</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Estilos del formulario m√≥vil */
        .form-container {
            padding: 10px;
            min-width: 200px;
        }
        .form-container label {
            display: block;
            font-weight: bold;
            margin-top: 8px;
            font-size: 12px;
        }
        .form-container input, .form-container select, .form-container textarea {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .btn-save {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            margin-top: 15px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Ajuste visual del popup */
        .leaflet-popup-content-wrapper { border-radius: 8px; }

        /* Bot√≥n de Ayuda/Instrucci√≥n flotante */
        .info-floating {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            pointer-events: none;
        }
        
        /* Control de capas mejorado */
        .leaflet-control-layers {
            background: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }
        
        /* Estilo para el loader */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            text-align: center;
            font-weight: bold;
        }
        
        /* Estilo para los pol√≠gonos del KML */
        .kml-polygon {
            fillColor: #3498db;
            color: #2980b9;
            weight: 3;
            opacity: 1;
            fillOpacity: 0.3;
        }
        
        .kml-polygon:hover {
            fillColor: #e74c3c;
            color: #c0392b;
            fillOpacity: 0.5;
            weight: 4;
        }
        
        /* Bot√≥n de limpiar */
        .leaflet-control-custom {
            background: white;
            border-radius: 4px;
            padding: 0;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .leaflet-control-custom a {
            display: block;
            padding: 8px 12px;
            text-decoration: none;
            color: #333;
            font-size: 12px;
        }
        
        .leaflet-control-custom a:hover {
            background: #f8f9fa;
        }
        
        /* Estilo para el indicador de carga */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="info-floating">Toca el mapa para registrar un evento</div>
    <div id="map"></div>
    <div id="loader" class="loader" style="display: none;">
        <div class="spinner"></div>
        <div>Cargando circunscripciones...</div>
        <div style="margin-top: 10px; font-size: 12px; color: #666;">circunscripciones.kml</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Evitar errores de variables no definidas
        'use strict';
        
        const chascomusCoord = [-35.5762, -58.0104];

        // --- INICIALIZAR MAPA ---
        const cyclOSM = L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
            maxZoom: 20, 
            attribution: '¬© CyclOSM'
        });
        
        const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri Topo'
        });

        const map = L.map('map', {
            center: chascomusCoord,
            zoom: 13,
            layers: [cyclOSM],
            zoomControl: false
        });
        
        L.control.zoom({ position: 'topright' }).addTo(map);

        // --- VARIABLES GLOBALES ---
        let kmlLayer = L.layerGroup();
        const markers = L.layerGroup().addTo(map);
        
        // --- FUNCI√ìN MEJORADA PARA CARGAR KML ---
        async function loadKML(url) {
            try {
                console.log('Iniciando carga de KML desde:', url);
                document.getElementById('loader').style.display = 'block';
                
                // Usar proxy CORS para evitar problemas
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + url);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const kmlText = await response.text();
                console.log('KML descargado, tama√±o:', kmlText.length, 'bytes');
                
                const parser = new DOMParser();
                const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
                
                // Verificar si hay errores en el XML
                const parserError = kmlDoc.getElementsByTagName('parsererror');
                if (parserError.length > 0) {
                    throw new Error('Error parseando XML: ' + parserError[0].textContent);
                }
                
                // Extraer todas las geometr√≠as
                const placemarks = kmlDoc.getElementsByTagName('Placemark');
                const polygons = [];
                const polylines = [];
                
                console.log('Encontrados', placemarks.length, 'placemarks');
                
                for (let i = 0; i < placemarks.length; i++) {
                    const placemark = placemarks[i];
                    
                    // Extraer nombre si existe
                    const nameElement = placemark.getElementsByTagName('name')[0];
                    const name = nameElement ? nameElement.textContent : `Circunscripci√≥n ${i + 1}`;
                    
                    // Buscar Polygon (pol√≠gonos cerrados)
                    const polygonsElements = placemark.getElementsByTagName('Polygon');
                    for (let polyElement of polygonsElements) {
                        const coordElement = polyElement.getElementsByTagName('coordinates')[0];
                        if (coordElement) {
                            const coords = parseCoordinates(coordElement.textContent);
                            if (coords.length > 0) {
                                polygons.push({name: name, coords: coords});
                            }
                        }
                    }
                    
                    // Buscar LineString (l√≠neas)
                    const linesElements = placemark.getElementsByTagName('LineString');
                    for (let lineElement of linesElements) {
                        const coordElement = lineElement.getElementsByTagName('coordinates')[0];
                        if (coordElement) {
                            const coords = parseCoordinates(coordElement.textContent);
                            if (coords.length > 0) {
                                polylines.push({name: name, coords: coords});
                            }
                        }
                    }
                }
                
                console.log('Pol√≠gonos encontrados:', polygons.length);
                console.log('L√≠neas encontradas:', polylines.length);
                
                return { polygons, polylines };
                
            } catch (error) {
                console.error('Error en loadKML:', error);
                throw error;
            }
        }
        
        // Funci√≥n auxiliar para parsear coordenadas
        function parseCoordinates(coordsText) {
            const coords = [];
            const lines = coordsText.trim().split(/\s+/);
            
            for (let line of lines) {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const lng = parseFloat(parts[0]);
                    const lat = parseFloat(parts[1]);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        coords.push([lat, lng]);
                    }
                }
            }
            return coords;
        }
        
        // --- CARGAR KML ---
        const kmlUrl = 'https://raw.githubusercontent.com/Javiergar900/prueba-topografica/6047b52c13c61d55185b69b85e96e507562fdf6e/circunscripciones.kml';
        
        loadKML(kmlUrl)
            .then(({ polygons, polylines }) => {
                // Limpiar capa anterior
                kmlLayer.clearLayers();
                
                // Crear pol√≠gonos
                polygons.forEach((poly, index) => {
                    if (poly.coords.length > 2) {
                        const polygon = L.polygon(poly.coords, {
                            className: 'kml-polygon',
                            fillColor: getColorForIndex(index),
                            color: '#2c3e50',
                            weight: 3,
                            opacity: 0.8,
                            fillOpacity: 0.3
                        }).addTo(kmlLayer);
                        
                        // A√±adir tooltip
                        polygon.bindTooltip(poly.name, {
                            permanent: false,
                            direction: 'center',
                            className: 'kml-tooltip'
                        });
                    }
                });
                
                // Crear l√≠neas
                polylines.forEach((line, index) => {
                    if (line.coords.length > 1) {
                        const polyline = L.polyline(line.coords, {
                            color: '#e74c3c',
                            weight: 2,
                            opacity: 0.7
                        }).addTo(kmlLayer);
                    }
                });
                
                // A√±adir al mapa
                map.addLayer(kmlLayer);
                
                // Calcular bounds
                let bounds = null;
                kmlLayer.eachLayer(layer => {
                    if (layer.getBounds) {
                        const layerBounds = layer.getBounds();
                        if (bounds === null) {
                            bounds = layerBounds;
                        } else {
                            bounds.extend(layerBounds);
                        }
                    }
                });
                
                // Ajustar vista si hay geometr√≠as
                if (bounds && bounds.isValid()) {
                    map.fitBounds(bounds.pad(0.1));
                    console.log('Mapa ajustado a bounds:', bounds);
                } else {
                    console.log('No se pudo calcular bounds, usando vista por defecto');
                }
                
                // Ocultar loader
                document.getElementById('loader').style.display = 'none';
                
                // Mostrar mensaje de √©xito
                const totalGeometries = polygons.length + polylines.length;
                L.popup()
                    .setLatLng(map.getCenter())
                    .setContent(`
                        <div style="text-align: center; padding: 10px;">
                            <h4 style="margin: 0 0 10px 0;">¬°KML Cargado!</h4>
                            <p>${polygons.length} pol√≠gonos<br>
                            ${polylines.length} l√≠neas<br>
                            Total: ${totalGeometries} geometr√≠as</p>
                        </div>
                    `)
                    .openOn(map);
                
                // Remover despu√©s de 3 segundos
                setTimeout(() => map.closePopup(), 3000);
                
            })
            .catch(error => {
                console.error('Error cargando KML:', error);
                document.getElementById('loader').innerHTML = 
                    '<div style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è Error cargando KML</div>' +
                    '<div style="font-size: 12px; color: #666;">' + error.message + '</div>' +
                    '<button onclick="window.location.reload()" style="margin-top: 10px; padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">Reintentar</button>';
                
                // Intentar cargar sin proxy despu√©s de 5 segundos
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                }, 5000);
            });
        
        // Funci√≥n para generar colores diferentes para cada pol√≠gono
        function getColorForIndex(index) {
            const colors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
            ];
            return colors[index % colors.length];
        }

        // --- CONTROL DE CAPAS ---
        const baseMaps = { 
            "Rural/Ciclistas": cyclOSM, 
            "Topogr√°fico": esriTopo 
        };
        
        const overlayMaps = {
            "Circunscripciones": kmlLayer,
            "Marcadores": markers
        };
        
        L.control.layers(baseMaps, overlayMaps, { 
            collapsed: true,
            position: 'topright'
        }).addTo(map);

        // --- L√ìGICA DE EVENTOS ---
        function saveEvent(lat, lng) {
            const tipo = document.getElementById('tipo').value;
            const obs = document.getElementById('obs').value;
            const hora = document.getElementById('hora').value;

            // Crear marcador
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: #e74c3c; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);">!</div>`
                })
            }).addTo(markers);
            
            marker.bindPopup(`
                <div style="max-width: 250px;">
                    <b style="color: #e74c3c;">${tipo}</b><br>
                    <small>Hora: ${hora}</small><br>
                    <small>Coords: ${lat.toFixed(4)}, ${lng.toFixed(4)}</small>
                    <hr style="margin: 5px 0;">
                    <div style="font-size: 12px;">${obs || 'Sin observaciones'}</div>
                    <div style="font-size: 10px; color: #666; margin-top: 5px;">
                        ${new Date().toLocaleDateString()}
                    </div>
                </div>
            `).openPopup();
            
            console.log('Evento guardado:', { lat, lng, tipo, hora, obs });
            
            map.closePopup();
        }

        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });

            const formHtml = `
                <div class="form-container">
                    <h3 style="margin:0 0 10px 0; color:#2c3e50;">Nuevo Reporte</h3>
                    <div style="font-size: 11px; color: #666; margin-bottom: 10px;">
                        ${lat.toFixed(6)}, ${lng.toFixed(6)}
                    </div>
                    
                    <label>Tipolog√≠a</label>
                    <select id="tipo">
                        <option value="Robo/Hurto">Robo/Hurto</option>
                        <option value="Presencia Sospechosa">Presencia Sospechosa</option>
                        <option value="Abigeato">Abigeato (Ganado)</option>
                        <option value="Vandalismo">Vandalismo</option>
                        <option value="Otro">Otro</option>
                    </select>

                    <label>Hora del evento</label>
                    <input type="time" id="hora" value="${timeString}">

                    <label>Observaciones</label>
                    <textarea id="obs" rows="3" placeholder="Descripci√≥n del evento..."></textarea>

                    <button class="btn-save" onclick="saveEvent(${lat}, ${lng})">GUARDAR EVENTO</button>
                </div>
            `;

            L.popup()
                .setLatLng([lat, lng])
                .setContent(formHtml)
                .openOn(map);
        });

        // --- CONTROLES PERSONALIZADOS ---
        // Control para limpiar marcadores
        const clearControl = L.control({position: 'bottomright'});
        clearControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-control-custom');
            div.innerHTML = '<a href="#" title="Limpiar marcadores">üóëÔ∏è Limpiar</a>';
            
            L.DomEvent.on(div, 'click', function(e) {
                L.DomEvent.stopPropagation(e);
                L.DomEvent.preventDefault(e);
                if (markers.getLayers().length > 0) {
                    if (confirm('¬øEliminar todos los marcadores de eventos?')) {
                        markers.clearLayers();
                        L.popup()
                            .setLatLng(map.getCenter())
                            .setContent('<div style="padding: 10px;">Marcadores eliminados</div>')
                            .openOn(map);
                        setTimeout(() => map.closePopup(), 1500);
                    }
                } else {
                    L.popup()
                        .setLatLng(map.getCenter())
                        .setContent('<div style="padding: 10px;">No hay marcadores para limpiar</div>')
                        .openOn(map);
                    setTimeout(() => map.closePopup(), 1500);
                }
            });
            
            return div;
        };
        clearControl.addTo(map);
        
        // Control para recargar KML
        const reloadControl = L.control({position: 'bottomright'});
        reloadControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-control-custom');
            div.innerHTML = '<a href="#" title="Recargar circunscripciones">üîÑ Recargar</a>';
            div.style.marginBottom = '50px';
            
            L.DomEvent.on(div, 'click', function(e) {
                L.DomEvent.stopPropagation(e);
                L.DomEvent.preventDefault(e);
                window.location.reload();
            });
            
            return div;
        };
        reloadControl.addTo(map);

        // Asegurar que las funciones est√©n disponibles globalmente
        window.saveEvent = saveEvent;

    </script>
</body>
</html>
