<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titulo - Seguridad Rural</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#e74c3c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            overflow: hidden;
            height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* App Container */
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header simple */
        .header {
            background: #126b7a;
            color: white;
            padding: 12px 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }
        
        .app-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .app-subtitle {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        /* Contenido principal */
        .content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Mapa (ocupa toda la pantalla por defecto) */
        #map {
            flex: 1;
            height: 100%;
            transition: all 0.3s ease;
        }
        
        /* Ocultar completamente la atribuci√≥n de Leaflet */
        .leaflet-control-attribution {
            display: none !important;
        }
        
        /* Formulario flotante */
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .form-container {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .form-header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            position: relative;
        }
        
        .form-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .form-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .close-form {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .form-body {
            padding: 20px;
        }
        
        /* Paso de ubicaci√≥n primero */
        .step-container {
            display: none;
        }
        
        .step-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s;
        }
        
        .step-dot.active {
            background: #e74c3c;
            transform: scale(1.2);
        }
        
        .step-title {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .step-description {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }
        
        /* Instrucci√≥n de ubicaci√≥n */
        .location-instruction {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .location-icon {
            font-size: 40px;
            color: #e74c3c;
            margin-bottom: 15px;
        }
        
        .location-instruction-text {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .location-subtext {
            font-size: 14px;
            color: #666;
        }
        
        /* Opciones de ubicaci√≥n */
        .location-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .location-option-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        
        .location-option-btn:hover {
            border-color: #3498db;
            background: #f0f7ff;
            transform: translateY(-2px);
        }
        
        .location-option-icon {
            font-size: 24px;
            color: #3498db;
            width: 40px;
            text-align: center;
        }
        
        .location-option-text {
            flex: 1;
        }
        
        .location-option-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .location-option-desc {
            font-size: 13px;
            color: #666;
        }
        
        /* Mapa para seleccionar ubicaci√≥n */
        .map-selector-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }
        
        .map-selector-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 2001;
        }
        
        .map-selector-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .map-selector-instructions {
            background: #f39c12;
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: 14px;
            z-index: 2001;
        }
        
        .map-selector-container {
            flex: 1;
            position: relative;
        }
        
        .map-selector-map {
            width: 100%;
            height: 100%;
        }
        
        .confirm-location-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2001;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .confirm-location-btn:hover {
            background: linear-gradient(135deg, #219653, #1e874b);
            transform: translateX(-50%) translateY(-2px);
        }
        
        .location-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            color: #e74c3c;
            font-size: 40px;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 2000;
            pointer-events: none;
        }
        
        /* Ubicaci√≥n seleccionada */
        .location-selected {
            background: #e8f5e9;
            border: 2px solid #27ae60;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); }
            100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
        }
        
        .location-selected-icon {
            font-size: 24px;
            color: #27ae60;
            margin-bottom: 10px;
        }
        
        .location-coords {
            font-family: monospace;
            font-size: 14px;
            color: #2c3e50;
            margin: 5px 0;
        }
        
        .change-location-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }
        
        /* Categor√≠as como botones grandes */
        .categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .category-btn {
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .category-btn:hover {
            border-color: #3498db;
            background: #f0f7ff;
        }
        
        .category-btn.active {
            border-color: #e74c3c;
            background: #ffeaea;
            color: #e74c3c;
        }
        
        .category-icon {
            font-size: 20px;
        }
        
        .category-label {
            font-size: 13px;
            font-weight: 500;
        }
        
        /* Campos del formulario */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s;
            font-family: inherit;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Botones de navegaci√≥n entre pasos */
        .step-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .step-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .step-next {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .step-next:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
        }
        
        .step-prev {
            background: #f0f0f0;
            color: #666;
        }
        
        .step-prev:hover {
            background: #e0e0e0;
        }
        
        /* Botones principales */
        .btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
            margin-top: 10px;
        }
        
        /* Bot√≥n flotante para nuevo reporte */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            cursor: pointer;
            z-index: 900;
            transition: all 0.3s;
            border: none;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }
        
        /* Bot√≥n para ver reportes */
        .view-reports-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            color: #2c3e50;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 900;
        }
        
        /* Mini lista de reportes */
        .reports-mini {
            position: fixed;
            top: 60px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 300px;
            max-height: 70vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        .reports-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reports-list {
            padding: 10px;
        }
        
        .report-mini-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .report-mini-item:last-child {
            border-bottom: none;
        }
        
        .report-mini-type {
            display: inline-block;
            padding: 3px 8px;
            background: #e74c3c;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 5px;
        }
        
        .report-mini-desc {
            font-size: 13px;
            margin: 5px 0;
        }
        
        /* Loader */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e74c3c;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast notification - POSICI√ìN AJUSTADA M√ÅS ABAJO */
        .toast {
            position: fixed;
            bottom: 120px; /* Cambiado de 80px a 120px */
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            max-width: 90%;
            text-align: center;
        }
        
        @keyframes slideIn {
            from { bottom: 80px; opacity: 0; }
            to { bottom: 120px; opacity: 1; }
        }
        
        /* Popup personalizado */
        .leaflet-popup-content {
            min-width: 250px !important;
        }
        
        /* Para Google Sheets */
        .sheets-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            color: #666;
            border-left: 4px solid #34a853;
        }
        
        /* Estado de conexi√≥n - POSICI√ìN AJUSTADA M√ÅS ABAJO */
        .connection-status {
            position: fixed;
            bottom: 160px; /* Cambiado de 90px a 160px */
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .connection-status.online {
            background: #27ae60;
            color: white;
        }
        
        .connection-status.offline {
            background: #e74c3c;
            color: white;
        }
        
        /* Bot√≥n de sincronizaci√≥n - POSICI√ìN AJUSTADA M√ÅS A LA DERECHA */
        .sync-btn {
            position: fixed;
            bottom: 20px;
            right: 90px; /* Cambiado de 90px a 120px en m√≥vil */
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            border: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .sync-btn.pending {
            background: #f39c12;
            animation: pulse 2s infinite;
        }
        
        .sync-btn.synced {
            background: #3498db;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Instalar PWA Banner */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2c3e50;
            color: white;
            padding: 15px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 1100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
        
        .install-text {
            font-size: 14px;
            flex: 1;
        }
        
        .install-buttons {
            display: flex;
            gap: 10px;
        }
        
        .install-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        
        .later-btn {
            background: transparent;
            color: #ddd;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        
        /* Cache status */
        .cache-status {
            position: fixed;
            top: 60px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 800;
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-container {
                width: 95%;
                max-height: 85vh;
            }
            
            .categories {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .reports-mini {
                width: 90%;
                left: 5%;
                right: 5%;
            }
            
            /* AJUSTE DE POSICI√ìN EN M√ìVIL */
            .sync-btn {
                right: 120px; /* M√°s a la derecha en m√≥vil */
                bottom: 90px;
            }
            
            .connection-status {
                bottom: 140px; /* Un poco m√°s arriba en m√≥vil */
            }
            
            .toast {
                bottom: 100px;
            }
            
            .install-banner {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .install-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .location-options {
                gap: 10px;
            }
            
            .location-option-btn {
                padding: 15px;
            }
        }
        .sync-btn {
    display: none !important;
}
        
        @media (max-width: 480px) {
            .sync-btn {
                right: 100px;
                bottom: 85px;
                width: 45px;
                height: 45px;
            }
            
            .fab {
                width: 55px;
                height: 55px;
                bottom: 15px;
                right: 15px;
            }
            
            .view-reports-btn {
                width: 45px;
                height: 45px;
                bottom: 15px;
                left: 15px;
            }
            
            .location-option-icon {
                font-size: 20px;
                width: 30px;
            }
            
            .location-option-title {
                font-size: 15px;
            }
            
            .confirm-location-btn {
                padding: 12px 25px;
                font-size: 15px;
                bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header simple -->
        <header class="header">
            <div class="app-title">Titulo</div>
            <div class="app-subtitle">Seguridad Rural - Reporte Ciudadano</div>
        </header>
        
        <!-- Contenido principal -->
        <div class="content">
            <div id="map"></div>
        </div>
        
        <!-- Bot√≥n flotante para nuevo reporte -->
        <button class="fab" onclick="showForm()">
            <i class="fas fa-plus"></i>
        </button>
        
        <!-- Bot√≥n para ver reportes -->
        <button class="view-reports-btn" onclick="toggleReports()" title="Ver mis reportes">
            <i class="fas fa-list"></i>
        </button>
        
        <!-- Estado de conexi√≥n (se a√±ade din√°micamente) -->
        <div id="connectionStatus" class="connection-status" style="display: none;"></div>
        
        <!-- Cache status -->
        <div id="cacheStatus" class="cache-status"></div>
    </div>
    
    <!-- Formulario flotante -->
    <div class="form-overlay" id="formOverlay">
        <div class="form-container">
            <div class="form-header">
                <button class="close-form" onclick="hideForm()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="form-title">Nuevo Reporte</div>
            </div>
            
            <div class="form-body">
                <!-- Indicador de pasos -->
                <div class="step-indicator">
                    <div class="step-dot" id="step1Dot"></div>
                    <div class="step-dot" id="step2Dot"></div>
                    <div class="step-dot" id="step3Dot"></div>
                </div>
                
                <!-- Paso 1: Seleccionar ubicaci√≥n -->
                <div class="step-container active" id="step1">
                    <div class="step-title">Paso 1: ¬øD√≥nde?</div>
                    <div class="step-description">Primero seleccion√° la ubicaci√≥n del evento</div>
                    
                    <div id="locationSelectedDisplay" style="display: none;">
                        <div class="location-selected">
                            <div class="location-selected-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div>¬°Ubicaci√≥n seleccionada!</div>
                            <div class="location-coords" id="selectedCoords"></div>
                            <button type="button" class="change-location-btn" onclick="changeLocation()">
                                <i class="fas fa-edit"></i> Cambiar ubicaci√≥n
                            </button>
                        </div>
                        
                        <div class="step-buttons">
                            <button type="button" class="step-btn step-prev" onclick="hideForm()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="button" class="step-btn step-next" onclick="nextStep()">
                                Siguiente <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="locationNotSelected">
                        <div class="location-instruction">
                            <div class="location-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-instruction-text">Seleccion√° c√≥mo quer√©s indicar la ubicaci√≥n</div>
                            <div class="location-subtext">Pod√©s usar tu ubicaci√≥n actual o buscar en el mapa</div>
                        </div>
                        
                        <div class="location-options">
                            <button type="button" class="location-option-btn" onclick="useCurrentLocation()">
                                <div class="location-option-icon">
                                    <i class="fas fa-location-crosshairs"></i>
                                </div>
                                <div class="location-option-text">
                                    <div class="location-option-title">Usar mi ubicaci√≥n actual</div>
                                    <div class="location-option-desc">Usa el GPS de tu dispositivo para obtener tu ubicaci√≥n precisa</div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #999;"></i>
                            </button>
                            
                            <button type="button" class="location-option-btn" onclick="openMapSelector()">
                                <div class="location-option-icon">
                                    <i class="fas fa-map"></i>
                                </div>
                                <div class="location-option-text">
                                    <div class="location-option-title">Seleccionar en el mapa</div>
                                    <div class="location-option-desc">Busca y selecciona manualmente la ubicaci√≥n exacta</div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #999;"></i>
                            </button>
                        </div>
                        
                        <button type="button" class="step-btn step-prev" onclick="hideForm()" style="margin-top: 20px;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
                
                <!-- Paso 2: Seleccionar categor√≠a -->
                <div class="step-container" id="step2">
                    <div class="step-title">Paso 2: ¬øQu√© pas√≥?</div>
                    <div class="step-description">Eleg√≠ el tipo de evento que quer√©s reportar</div>
                    
                    <div class="categories" id="categories">
                        <div class="category-btn" data-category="robo">
                            <i class="fas fa-gem category-icon"></i>
                            <span class="category-label">Robo/Hurto</span>
                        </div>
                        <div class="category-btn" data-category="sospechoso">
                            <i class="fas fa-user-secret category-icon"></i>
                            <span class="category-label">Persona Sospechosa</span>
                        </div>
                        <div class="category-btn" data-category="animales">
                            <i class="fas fa-cow category-icon"></i>
                            <span class="category-label">Animales/Ganado</span>
                        </div>
                        <div class="category-btn" data-category="vandalismo">
                            <i class="fas fa-spray-can category-icon"></i>
                            <span class="category-label">Vandalismo</span>
                        </div>
                        <div class="category-btn" data-category="accidente">
                            <i class="fas fa-car-crash category-icon"></i>
                            <span class="category-label">Accidente</span>
                        </div>
                        <div class="category-btn" data-category="incendio">
                            <i class="fas fa-fire category-icon"></i>
                            <span class="category-label">Incendio</span>
                        </div>
                        <div class="category-btn" data-category="otros">
                            <i class="fas fa-ellipsis-h category-icon"></i>
                            <span class="category-label">Otros</span>
                        </div>
                    </div>
                    
                    <div class="step-buttons">
                        <button type="button" class="step-btn step-prev" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i> Atr√°s
                        </button>
                        <button type="button" class="step-btn step-next" onclick="nextStep()" id="nextStep2Btn" disabled>
                            Siguiente <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Paso 3: Detalles completos -->
                <div class="step-container" id="step3">
                    <div class="step-title">Paso 3: Detalles completos</div>
                    <div class="step-description">Complet√° los detalles del reporte</div>
                    
                    <!-- Detalles espec√≠ficos -->
                    <div class="form-group" id="detailsGroup">
                        <label class="form-label" id="detailsLabel">Tipo espec√≠fico</label>
                        <select class="form-select" id="eventDetails">
                            <!-- Se llena din√°micamente seg√∫n categor√≠a -->
                        </select>
                    </div>
                    
                    <!-- Descripci√≥n -->
                    <div class="form-group">
                        <label class="form-label">Descripci√≥n (opcional)</label>
                        <textarea class="form-textarea" id="description" 
                                  placeholder="Inserte aqui todos los detalles posibles y precisiones"></textarea>
                    </div>
                    
                    <!-- Fecha y hora -->
                    <div class="form-group">
                        <label class="form-label">¬øCu√°ndo pas√≥?</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="date" class="form-input" id="eventDate" value="">
                            <input type="time" class="form-input" id="eventTime" value="">
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n para Google Sheets -->
                    <div class="sheets-info">
                        <i class="fas fa-info-circle"></i>
                        <span id="syncInfo">Conectando a Google Sheets...</span>
                    </div>
                    
                    <div class="step-buttons">
                        <button type="button" class="step-btn step-prev" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i> Atr√°s
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveReport()">
                            <i class="fas fa-paper-plane"></i> <span id="submitBtnText">Enviar Reporte</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Selector de ubicaci√≥n en mapa -->
    <div class="map-selector-overlay" id="mapSelectorOverlay">
        <div class="map-selector-header">
            <div class="map-selector-title">Seleccionar ubicaci√≥n</div>
            <button onclick="closeMapSelector()" style="background:none; border:none; color:white; cursor:pointer; font-size: 20px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="map-selector-instructions">
            <i class="fas fa-hand-pointer"></i> Toc√° en el mapa para seleccionar la ubicaci√≥n exacta
        </div>
        <div class="map-selector-container">
            <div id="mapSelector" class="map-selector-map"></div>
            <div class="location-pin">
                <i class="fas fa-map-pin"></i>
            </div>
            <button class="confirm-location-btn" id="confirmLocationBtn" onclick="confirmMapLocation()">
                <i class="fas fa-check"></i> Confirmar esta ubicaci√≥n
            </button>
        </div>
    </div>
    
    <!-- Mini lista de reportes -->
    <div class="reports-mini" id="reportsMini">
        <div class="reports-header">
            <span>Mis Reportes</span>
            <button onclick="toggleReports()" style="background:none; border:none; color:white; cursor:pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="reports-list" id="reportsList">
            <!-- Se llena din√°micamente -->
        </div>
    </div>
    
    <!-- Instalar PWA Banner -->
    <div class="install-banner" id="installBanner">
        <div class="install-text">
            <i class="fas fa-download"></i> Instalar app para mejor experiencia offline
        </div>
        <div class="install-buttons">
            <button class="install-btn" onclick="installPWA()">Instalar</button>
            <button class="later-btn" onclick="hideInstallBanner()">Ahora no</button>
        </div>
    </div>
    
    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="loader-spinner"></div>
        <div style="margin-top: 15px; font-size: 14px; color: #2c3e50;" id="loaderText">Cargando mapa de Chascom√∫s...</div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage"></span>
    </div>
    

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        'use strict';
        
        // Configuraci√≥n
        const CHASCOMUS_COORD = [-35.5762, -58.0104];
        const SHEETBEST_API = 'https://api.sheetbest.com/sheets/f541beca-e53f-4201-8d8f-feb75f92509b';
        const APP_VERSION = '1.0.0';
        
        let map, mapSelector, markersLayer, kmlPolygons = [];
        let selectedLocation = null;
        let tempMapLocation = null;
        let selectedCategory = null;
        let currentStep = 1;
        let reports = JSON.parse(localStorage.getItem('chascomus_reports') || '[]');
        let pendingReports = JSON.parse(localStorage.getItem('chascomus_pending_reports') || '[]');
        let isOnline = navigator.onLine;
        let syncInProgress = false;
        let deferredPrompt = null;
        let isAppInstalled = false;
        
        // Detectar si la app est√° instalada
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
            isAppInstalled = true;
        }
        
        // Detalles por categor√≠a
        const categoryDetails = {
            robo: [
                'Opcion 1',
                'Opcion 2',
                'Opcion 3',
                'Opcion 4',
                'Opcion 5',
                'Opcion 6'
            ],
            sospechoso: [
                'Opcion 1',
                'Opcion 2',
                'Opcion 3',
                'Opcion 4',
                'Opcion 5',
                'Opcion 6'
            ],
            animales: [
                'Opcion 1',
                'Opcion 2',
                'Opcion 3',
                'Opcion 4',
                'Opcion 5',
                'Opcion 6 '
            ],
            vandalismo: [
                'Pintadas',
                'Rotura de propiedad',
                'Incendio provocado',
                'Da√±o',
                'Otro'
            ],
            accidente: [
                'Opcion',
                'Opcion',
                'Opcion',
                'Opcion',
                'Opcion',
                'Opcion'
            ],
            incendio: [
                'Incendio forestal',
                'Incendio de pastizales',
                'Incendio estructural',
                'Otro'
            ],
            otros: [
                'Opcion',
                'Opcion',
                'Opcion',
                'Opcion',
                'Opcion',
                'Opcion'
            ]
        };
        
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus();
            showToast('‚úÖ Conexi√≥n restablecida', 'success');
            syncPendingReports();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus();
            showToast('‚ö†Ô∏è Sin conexi√≥n - Los datos se guardar√°n localmente', 'warning');
        });
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (!isAppInstalled) {
                setTimeout(() => {
                    showInstallBanner();
                }, 5000);
            }
        });
        
        document.addEventListener('DOMContentLoaded', initApp);
        
        async function initApp() {
            document.getElementById('loaderText').textContent = 
                isOnline ? 'Cargando recursos...' : 'Cargando en modo offline...';
            
            const now = new Date();
            document.getElementById('eventDate').value = now.toISOString().split('T')[0];
            document.getElementById('eventTime').value = now.toTimeString().slice(0, 5);
            
            initMap();
            
            initMapSelector();
            
            if (isOnline) {
                await loadKML();
                await loadKMLToSelector();
            } else {
                showToast('üåê Modo offline - Usando cach√© local', 'info');
                const cachedKML = localStorage.getItem('chascomus_kml');
                if (cachedKML) {
                    loadKMLFromCache(cachedKML);
                    loadKMLToSelectorFromCache(cachedKML);
                }
            }
            
            loadExistingReports();
            
            setupCategories();
            
            updateConnectionStatus();
            
            addSyncButton();
            
            checkServiceWorker();
            
            if (isOnline && pendingReports.length > 0) {
                setTimeout(() => {
                    showToast(`üì§ ${pendingReports.length} reporte(s) pendiente(s) - Sincronizando...`, 'info');
                    syncPendingReports();
                }, 2000);
            }
            
            updateCacheStatus();
            
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                if (deferredPrompt && !isAppInstalled) {
                    setTimeout(() => {
                        showInstallBanner();
                    }, 1000);
                }
            }, 1500);
        }
        
        function initMap() {
            map = L.map('map', {
                center: CHASCOMUS_COORD,
                zoom: 12,
                zoomControl: true,
                zoomControlPos: 'topright',
                attributionControl: false
            });
            
            L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
                maxZoom: 20,
                crossOrigin: true
            }).addTo(map);
            
            markersLayer = L.layerGroup().addTo(map);
        }
        
        function initMapSelector() {
            mapSelector = L.map('mapSelector', {
                center: CHASCOMUS_COORD,
                zoom: 13,
                zoomControl: true,
                zoomControlPos: 'topright',
                attributionControl: false
            });
            
            L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
                maxZoom: 20,
                crossOrigin: true
            }).addTo(mapSelector);
            
            mapSelector.on('click', function(e) {
                tempMapLocation = e.latlng;
                document.getElementById('confirmLocationBtn').style.display = 'flex';
                showToast('üìç Toc√° "Confirmar" para usar esta ubicaci√≥n');
            });
        }
        
        async function loadKML() {
            const kmlUrl = 'https://raw.githubusercontent.com/Javiergar900/prueba-topografica/main/circunscripciones.kml';
            
            try {
                showToast('üó∫Ô∏è Cargando mapas de Chascom√∫s...');
                const response = await fetch(kmlUrl);
                const kmlText = await response.text();
                
                loadKMLToMap(kmlText);
                
                localStorage.setItem('chascomus_kml', kmlText);
                
                showToast('‚úÖ Mapas cargados correctamente');
                
            } catch (error) {
                console.log('KML no cargado:', error);
            }
        }
        
        function loadKMLToMap(kmlText) {
            const polygons = parseKML(kmlText);
            
            polygons.forEach(polygon => {
                const poly = L.polygon(polygon.coordinates, {
                    color: '#2c3e50',
                    weight: 2,
                    opacity: 0.5,
                    fillOpacity: 0.1,
                    interactive: false
                })
                .bindTooltip(polygon.name, {direction: 'center'})
                .addTo(map);
                
                kmlPolygons.push(poly);
            });
        }
        
        async function loadKMLToSelector() {
            const kmlUrl = 'https://raw.githubusercontent.com/Javiergar900/prueba-topografica/main/circunscripciones.kml';
            
            try {
                const response = await fetch(kmlUrl);
                const kmlText = await response.text();
                loadKMLToSelectorMap(kmlText);
            } catch (error) {
                console.log('KML no cargado para selector:', error);
            }
        }
        
        function loadKMLToSelectorMap(kmlText) {
            const polygons = parseKML(kmlText);
            
            polygons.forEach(polygon => {
                L.polygon(polygon.coordinates, {
                    color: '#2c3e50',
                    weight: 2,
                    opacity: 0.5,
                    fillOpacity: 0.1,
                    interactive: false
                }).addTo(mapSelector);
            });
        }
        
        function loadKMLFromCache(kmlText) {
            loadKMLToMap(kmlText);
        }
        
        function loadKMLToSelectorFromCache(kmlText) {
            loadKMLToSelectorMap(kmlText);
        }
        
        function parseKML(kmlText) {
            const parser = new DOMParser();
            const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
            const polygons = [];
            const placemarks = kmlDoc.getElementsByTagName('Placemark');
            
            for (let i = 0; i < placemarks.length; i++) {
                const placemark = placemarks[i];
                let name = `Zona ${i + 1}`;
                
                const nameElements = placemark.getElementsByTagName('name');
                if (nameElements.length > 0) {
                    name = nameElements[0].textContent;
                }
                
                const coordElements = placemark.getElementsByTagName('coordinates');
                for (let coordElement of coordElements) {
                    const coordsText = coordElement.textContent.trim();
                    const coords = parseCoordinates(coordsText);
                    
                    if (coords.length > 2) {
                        polygons.push({ name, coordinates: coords });
                    }
                }
            }
            
            return polygons;
        }
        
        function parseCoordinates(text) {
            const coords = [];
            const parts = text.split(/\s+/);
            
            for (let part of parts) {
                if (!part.trim()) continue;
                const [lng, lat] = part.split(',').map(Number);
                if (!isNaN(lat) && !isNaN(lng)) {
                    coords.push([lat, lng]);
                }
            }
            
            return coords;
        }
        
        function setupCategories() {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    selectedCategory = this.dataset.category;
                    
                    document.getElementById('nextStep2Btn').disabled = false;
                    
                    if (currentStep === 3) {
                        showCategoryDetails();
                    }
                });
            });
        }
        
        function showCategoryDetails() {
            const detailsGroup = document.getElementById('detailsGroup');
            const select = document.getElementById('eventDetails');
            
            if (selectedCategory && categoryDetails[selectedCategory]) {
                detailsGroup.style.display = 'block';
                select.innerHTML = '<option value="">Seleccionar tipo espec√≠fico</option>';
                
                categoryDetails[selectedCategory].forEach(detail => {
                    const option = document.createElement('option');
                    option.value = detail;
                    option.textContent = detail;
                    select.appendChild(option);
                });
            } else {
                detailsGroup.style.display = 'none';
            }
        }
        
        function useCurrentLocation() {
            if (!navigator.geolocation) {
                showToast('‚ùå Tu navegador no soporta geolocalizaci√≥n', 'error');
                return;
            }
            
            showToast('üìç Obteniendo tu ubicaci√≥n actual...');
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    selectedLocation = L.latLng(
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    
                    map.setView(selectedLocation, 16);
                    
                    updateLocationStepDisplay();
                    showToast('‚úÖ Ubicaci√≥n actual obtenida');
                },
                error => {
                    showToast('‚ùå No se pudo obtener la ubicaci√≥n', 'error');
                    setTimeout(() => {
                        if (confirm('¬øQuer√©s seleccionar la ubicaci√≥n en el mapa en su lugar?')) {
                            openMapSelector();
                        }
                    }, 500);
                }
            );
        }
        
        function openMapSelector() {
            document.getElementById('formOverlay').style.display = 'none';
            
            document.getElementById('mapSelectorOverlay').style.display = 'flex';
            
            if (selectedLocation) {
                mapSelector.setView(selectedLocation, 16);
                tempMapLocation = selectedLocation;
                document.getElementById('confirmLocationBtn').style.display = 'flex';
            } else {
                mapSelector.setView(CHASCOMUS_COORD, 13);
                tempMapLocation = null;
                document.getElementById('confirmLocationBtn').style.display = 'none';
            }
            
            setTimeout(() => {
                mapSelector.invalidateSize();
            }, 100);
        }
        
        function closeMapSelector() {
            document.getElementById('mapSelectorOverlay').style.display = 'none';
            document.getElementById('formOverlay').style.display = 'flex';
        }
        
        function confirmMapLocation() {
            if (!tempMapLocation) {
                showToast('‚ùå Primero seleccion√° un punto en el mapa', 'error');
                return;
            }
            
            selectedLocation = tempMapLocation;
            
            closeMapSelector();
            
            map.setView(selectedLocation, 16);
            
            updateLocationStepDisplay();
            showToast('üìç Ubicaci√≥n seleccionada en el mapa');
        }
        
        function updateLocationStepDisplay() {
            if (selectedLocation) {
                const text = `${selectedLocation.lat.toFixed(5)}, ${selectedLocation.lng.toFixed(5)}`;
                document.getElementById('selectedCoords').textContent = text;
                
                document.getElementById('locationSelectedDisplay').style.display = 'block';
                document.getElementById('locationNotSelected').style.display = 'none';
            } else {
                document.getElementById('locationSelectedDisplay').style.display = 'none';
                document.getElementById('locationNotSelected').style.display = 'block';
            }
        }
        
        function changeLocation() {
            // Resetear ubicaci√≥n y mostrar opciones nuevamente
            selectedLocation = null;
            updateLocationStepDisplay();
        }
        
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            const submitBtn = document.getElementById('submitBtnText');
            const syncInfo = document.getElementById('syncInfo');
            
            if (isOnline) {
                statusDiv.className = 'connection-status online';
                statusDiv.innerHTML = '<i class="fas fa-wifi"></i> En l√≠nea';
                submitBtn.textContent = 'Enviar Reporte';
                statusDiv.style.display = 'flex';
            } else {
                statusDiv.className = 'connection-status offline';
                statusDiv.innerHTML = '<i class="fas fa-signal-slash"></i> Sin conexi√≥n';
                submitBtn.textContent = 'Guardar Localmente';
                syncInfo.innerHTML = '<i class="fas fa-clock"></i> Modo offline - Se enviar√° al recuperar conexi√≥n';
                statusDiv.style.display = 'flex';
            }
            
            // Actualizar bot√≥n de sincronizaci√≥n
            updateSyncButton();
        }
        
        function addSyncButton() {
            // Crear bot√≥n si no existe
            if (!document.getElementById('syncButton')) {
                const syncBtn = document.createElement('button');
                syncBtn.id = 'syncButton';
                syncBtn.className = 'sync-btn';
                syncBtn.title = 'Sincronizar reportes pendientes';
                syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                syncBtn.onclick = syncPendingReports;
                document.body.appendChild(syncBtn);
            }
            updateSyncButton();
        }
        
        function updateSyncButton() {
            const syncBtn = document.getElementById('syncButton');
            if (!syncBtn) return;
            
            if (pendingReports.length > 0 && isOnline) {
                syncBtn.className = 'sync-btn pending';
                syncBtn.title = `${pendingReports.length} reporte(s) pendiente(s) - Sincronizar`;
                syncBtn.style.cursor = 'pointer';
                syncBtn.style.opacity = '1';
            } else if (pendingReports.length > 0 && !isOnline) {
                syncBtn.className = 'sync-btn pending';
                syncBtn.title = `${pendingReports.length} pendiente(s) - Esperando conexi√≥n`;
                syncBtn.style.opacity = '0.5';
                syncBtn.style.cursor = 'not-allowed';
            } else {
                syncBtn.className = 'sync-btn synced';
                syncBtn.title = 'Todo sincronizado';
                syncBtn.style.opacity = '1';
                syncBtn.style.cursor = 'pointer';
            }
        }
        
        function updateCacheStatus() {
            const cacheDiv = document.getElementById('cacheStatus');
            const totalSpace = 5 * 1024 * 1024; // 5MB estimado
            const usedSpace = JSON.stringify(reports).length + 
                             JSON.stringify(pendingReports).length +
                             (localStorage.getItem('chascomus_kml') || '').length;
            
            const percentage = Math.min(100, (usedSpace / totalSpace) * 100);
            cacheDiv.innerHTML = `  ${Math.round(percentage)}`;
            
            if (percentage > 80) {
                cacheDiv.style.background = 'rgba(231, 76, 60, 0.8)';
            } else if (percentage > 50) {
                cacheDiv.style.background = 'rgba(241, 196, 15, 0.8)';
            } else {
                cacheDiv.style.background = 'rgba(0,0,0,0.7)';
            }
            
            // Mostrar solo si hay datos
            cacheDiv.style.display = reports.length > 0 ? 'block' : 'none';
        }
        
        function showForm() {
            document.getElementById('formOverlay').style.display = 'flex';
            
            // Iniciar siempre en paso 1 (ubicaci√≥n)
            goToStep(1);
            
            // Actualizar estado de conexi√≥n en el formulario
            updateConnectionStatus();
        }
        
        function hideForm() {
            document.getElementById('formOverlay').style.display = 'none';
            resetForm();
        }
        
        function resetForm() {
            // Resetear pasos
            goToStep(1);
            
            // Resetear formulario
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('detailsGroup').style.display = 'none';
            document.getElementById('description').value = '';
            selectedCategory = null;
            
            // Resetear bot√≥n siguiente del paso 2
            document.getElementById('nextStep2Btn').disabled = true;
        }
        
        function goToStep(step) {
            currentStep = step;
            
            document.querySelectorAll('.step-container').forEach(el => {
                el.classList.remove('active');
            });
            
            document.getElementById(`step${step}`).classList.add('active');
            
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                if (index < step) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
            
            if (step === 1) {
                updateLocationStepDisplay();
            }
            
            if (step === 3 && selectedCategory) {
                showCategoryDetails();
            }
        }
        
        function nextStep() {
            if (currentStep === 1) {
                if (!selectedLocation) {
                    showToast('‚ùå Primero seleccion√° una ubicaci√≥n', 'error');
                    return;
                }
                goToStep(2);
            } else if (currentStep === 2) {
                if (!selectedCategory) {
                    showToast('‚ùå Seleccion√° una categor√≠a', 'error');
                    return;
                }
                goToStep(3);
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                goToStep(currentStep - 1);
            }
        }
        
        async function saveReportToSheet(report) {
            const sheetData = {
                'Fecha': report.date,
                'Hora': report.time,
                'Categor√≠a': report.category,
                'Detalles': report.details,
                'Descripci√≥n': report.description,
                'Latitud': report.location.lat,
                'Longitud': report.location.lng,
                'Timestamp': report.timestamp,
                'Estado': report.synced ? 'Enviado' : 'Pendiente',
                'Versi√≥n App': APP_VERSION
            };

            try {
                const response = await fetch(SHEETBEST_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sheetData)
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Reporte enviado a SheetBest:', result);
                return true;
            } catch (error) {
                console.error('‚ùå Error enviando a SheetBest:', error);
                return false;
            }
        }
        
        async function syncPendingReports() {
            if (syncInProgress || !isOnline || pendingReports.length === 0) {
                if (!isOnline) {
                    showToast('‚ùå No hay conexi√≥n a internet', 'error');
                }
                return;
            }
            
            syncInProgress = true;
            showToast(`üîÑ Sincronizando ${pendingReports.length} reporte(s)...`, 'info');
            
            const successful = [];
            const failed = [];
            
            const pendingCopy = [...pendingReports];
            
            for (const report of pendingCopy) {
                try {
                    const success = await saveReportToSheet(report);
                    
                    if (success) {
                        successful.push(report.id);
                        
                        const reportIndex = reports.findIndex(r => r.id === report.id);
                        if (reportIndex !== -1) {
                            reports[reportIndex].synced = true;
                        }
                        
                        const pendingIndex = pendingReports.findIndex(r => r.id === report.id);
                        if (pendingIndex !== -1) {
                            pendingReports.splice(pendingIndex, 1);
                        }
                    } else {
                        failed.push(report.id);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                } catch (error) {
                    console.error('Error sincronizando reporte:', error);
                    failed.push(report.id);
                }
            }
            
            localStorage.setItem('chascomus_reports', JSON.stringify(reports));
            localStorage.setItem('chascomus_pending_reports', JSON.stringify(pendingReports));
            
            syncInProgress = false;
            updateSyncButton();
            updateCacheStatus();
            
            if (successful.length > 0) {
                showToast(`‚úÖ ${successful.length} reporte(s) sincronizado(s) exitosamente`);
                updateReportsList();
            }
            
            if (failed.length > 0) {
                showToast(`‚ö†Ô∏è ${failed.length} reporte(s) no se pudieron sincronizar`, 'warning');
            }
            
            setTimeout(() => {
                const statusDiv = document.getElementById('connectionStatus');
                if (statusDiv && pendingReports.length === 0) {
                    statusDiv.style.display = 'none';
                }
            }, 3000);
        }
        
        function saveReport() {
            if (!selectedCategory) {
                showToast('‚ùå Seleccion√° una categor√≠a', 'error');
                return;
            }
            
            if (!selectedLocation) {
                showToast('‚ùå Seleccion√° una ubicaci√≥n', 'error');
                return;
            }
            
            const category = document.querySelector('.category-btn.active .category-label').textContent;
            const details = document.getElementById('eventDetails').value || 'No especificado';
            const description = document.getElementById('description').value.trim() || 'Sin descripci√≥n';
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            
            const report = {
                id: Date.now(),
                category: category,
                details: details,
                description: description,
                date: date,
                time: time,
                location: {
                    lat: selectedLocation.lat,
                    lng: selectedLocation.lng
                },
                timestamp: new Date().toISOString(),
                synced: false
            };
            
            reports.unshift(report);
            localStorage.setItem('chascomus_reports', JSON.stringify(reports));
            
            addMarker(report);
            
            if (isOnline) {
                showToast('üì§ Enviando reporte...');
                
                saveReportToSheet(report)
                    .then(success => {
                        if (success) {
                            report.synced = true;
                            const index = reports.findIndex(r => r.id === report.id);
                            if (index !== -1) {
                                reports[index].synced = true;
                                localStorage.setItem('chascomus_reports', JSON.stringify(reports));
                            }
                            showToast('‚úÖ Reporte enviado exitosamente');
                        } else {
                            pendingReports.push(report);
                            localStorage.setItem('chascomus_pending_reports', JSON.stringify(pendingReports));
                            showToast('‚ö†Ô∏è Reporte guardado localmente. Se enviar√° cuando haya conexi√≥n', 'warning');
                            updateSyncButton();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        pendingReports.push(report);
                        localStorage.setItem('chascomus_pending_reports', JSON.stringify(pendingReports));
                        showToast('‚ö†Ô∏è Reporte guardado localmente. Se enviar√° cuando haya conexi√≥n', 'warning');
                        updateSyncButton();
                    });
            } else {
                pendingReports.push(report);
                localStorage.setItem('chascomus_pending_reports', JSON.stringify(pendingReports));
                showToast('üì± Reporte guardado localmente. Se enviar√° cuando haya conexi√≥n', 'warning');
                updateSyncButton();
            }
            
            hideForm();
            
            updateReportsList();
            updateCacheStatus();
        }
        
        function addMarker(report) {
            const colors = {
                'Robo/Hurto': '#e74c3c',
                'Persona Sospechosa': '#f39c12',
                'Animales/Ganado': '#27ae60',
                'Vandalismo': '#8e44ad',
                'Accidente': '#3498db',
                'Incendio': '#d35400',
                'Otros': '#7f8c8d'
            };
            
            const color = colors[report.category] || '#2c3e50';
            const syncIcon = report.synced ? '‚úì' : '‚è≥';
            
            const marker = L.marker([report.location.lat, report.location.lng], {
                icon: L.divIcon({
                    className: 'report-marker',
                    html: `<div style="background: ${color}; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">${syncIcon}</div>`
                })
            }).addTo(markersLayer);
            
            marker.bindPopup(`
                <div style="min-width: 200px;">
                    <h4 style="margin:0 0 5px 0; color:${color};">${report.category}</h4>
                    <p style="margin:5px 0; font-size:14px;">${report.description}</p>
                    <hr style="margin:8px 0;">
                    <div style="font-size:12px; color:#666;">
                        <div><strong>Tipo:</strong> ${report.details}</div>
                        <div><strong>Fecha:</strong> ${report.date} ${report.time}</div>
                        <div><strong>Coords:</strong> ${report.location.lat.toFixed(5)}, ${report.location.lng.toFixed(5)}</div>
                        <div><strong>Estado:</strong> ${report.synced ? '<span style="color:green;">‚úì Enviado</span>' : '<span style="color:orange;">‚è≥ Pendiente</span>'}</div>
                    </div>
                </div>
            `);
            
            marker.reportId = report.id;
        }
        
        function loadExistingReports() {
            reports.forEach(report => addMarker(report));
            updateReportsList();
        }
        
        function updateReportsList() {
            const container = document.getElementById('reportsList');
            
            if (reports.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:30px 20px; color:#999;">
                        <i class="fas fa-inbox" style="font-size:40px; margin-bottom:10px;"></i>
                        <p>No hay reportes a√∫n</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            reports.slice(0, 10).forEach(report => {
                const isPending = pendingReports.some(p => p.id === report.id);
                const syncIcon = report.synced ? 
                    '<i class="fas fa-check" style="color: #27ae60; margin-left: 5px;"></i>' : 
                    '<i class="fas fa-clock" style="color: #f39c12; margin-left: 5px;"></i>';
                
                html += `
                    <div class="report-mini-item" onclick="viewReport(${report.id})">
                        <div class="report-mini-type">
                            ${report.category}
                            ${syncIcon}
                        </div>
                        <div class="report-mini-desc">${report.description.substring(0, 60)}${report.description.length > 60 ? '...' : ''}</div>
                        <div style="font-size:11px; color:#999;">
                            ${report.date} ${report.time}
                            ${isPending ? '<span style="color:#f39c12;"> (Pendiente)</span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            if (reports.length > 10) {
                html += `
                    <div style="text-align:center; padding:10px; color:#3498db; font-size:13px;">
                        +${reports.length - 10} reportes m√°s
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function viewReport(id) {
            const report = reports.find(r => r.id === id);
            if (!report) return;
            
            map.setView([report.location.lat, report.location.lng], 16);
            
            markersLayer.eachLayer(layer => {
                if (layer.reportId === id) {
                    layer.openPopup();
                }
            });
            
            toggleReports();
        }
        
        function toggleReports() {
            const mini = document.getElementById('reportsMini');
            mini.style.display = mini.style.display === 'block' ? 'none' : 'block';
            if (mini.style.display === 'block') {
                updateReportsList();
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            const text = document.getElementById('toastMessage');
            
            text.textContent = message;
            
            if (type === 'error') {
                toast.style.background = '#e74c3c';
                icon.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                toast.style.background = '#f39c12';
                icon.className = 'fas fa-exclamation-triangle';
            } else if (type === 'info') {
                toast.style.background = '#3498db';
                icon.className = 'fas fa-info-circle';
            } else {
                toast.style.background = '#27ae60';
                icon.className = 'fas fa-check-circle';
            }
            
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        function showInstallBanner() {
            if (deferredPrompt && !isAppInstalled) {
                const banner = document.getElementById('installBanner');
                banner.style.display = 'flex';
                
                setTimeout(() => {
                    hideInstallBanner();
                }, 30000);
            }
        }
        
        function hideInstallBanner() {
            const banner = document.getElementById('installBanner');
            banner.style.display = 'none';
        }
        
        async function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                showToast('‚úÖ App instalada - Ahora funciona totalmente offline');
                isAppInstalled = true;
                hideInstallBanner();
            } else {
                showToast('‚ùå Instalaci√≥n cancelada', 'warning');
            }
            
            deferredPrompt = null;
        }
        
        async function checkServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('‚úÖ Service Worker registrado:', registration);
                    
                    // Verificar actualizaciones
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showToast('üîÑ Nueva versi√≥n disponible - Recarg√° la app', 'info');
                            }
                        });
                    });
                } catch (error) {
                    console.log('‚ùå Service Worker no registrado:', error);
                }
            }
        }
        
        window.showForm = showForm;
        window.hideForm = hideForm;
        window.useCurrentLocation = useCurrentLocation;
        window.openMapSelector = openMapSelector;
        window.closeMapSelector = closeMapSelector;
        window.confirmMapLocation = confirmMapLocation;
        window.changeLocation = changeLocation;
        window.saveReport = saveReport;
        window.toggleReports = toggleReports;
        window.viewReport = viewReport;
        window.syncPendingReports = syncPendingReports;
        window.installPWA = installPWA;
        window.hideInstallBanner = hideInstallBanner;
        window.nextStep = nextStep;
        window.prevStep = prevStep;
    </script>
</body>
</html>
