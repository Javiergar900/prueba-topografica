<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chascom√∫s Rural - Seguridad</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Estilos del formulario m√≥vil */
        .form-container {
            padding: 10px;
            min-width: 200px;
        }
        .form-container label {
            display: block;
            font-weight: bold;
            margin-top: 8px;
            font-size: 12px;
        }
        .form-container input, .form-container select, .form-container textarea {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .btn-save {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            margin-top: 15px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Ajuste visual del popup */
        .leaflet-popup-content-wrapper { border-radius: 8px; }

        /* Bot√≥n de Ayuda/Instrucci√≥n flotante */
        .info-floating {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            pointer-events: none;
        }
        
        /* Estilo para los pol√≠gonos del KML */
        .kml-polygon {
            fillColor: #3498db;
            color: #2980b9;
            weight: 3;
            opacity: 0.9;
            fillOpacity: 0.3;
        }
        
        .kml-polygon:hover {
            fillColor: #e74c3c;
            color: #c0392b;
            fillOpacity: 0.5;
            weight: 4;
        }
        
        /* Controles personalizados */
        .leaflet-control-custom {
            background: white;
            border-radius: 4px;
            padding: 0;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .leaflet-control-custom a {
            display: block;
            padding: 8px 12px;
            text-decoration: none;
            color: #333;
            font-size: 12px;
        }
        
        .leaflet-control-custom a:hover {
            background: #f8f9fa;
        }
        
        /* Loader */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            text-align: center;
            display: none;
        }
        
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="info-floating">Toca el mapa para registrar un evento</div>
    <div id="map"></div>
    <div id="loader" class="loader">
        <div class="loader-spinner"></div>
        <div>Cargando circunscripciones...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        'use strict';
        
        const chascomusCoord = [-35.5762, -58.0104];
        
        // Inicializar mapa
        const map = L.map('map', {
            center: chascomusCoord,
            zoom: 9,
            zoomControl: false
        });
        
        L.control.zoom({ position: 'topright' }).addTo(map);
        
        // Capas base
        const cyclOSM = L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
            maxZoom: 20, 
            attribution: '¬© CyclOSM'
        }).addTo(map);
        
        const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri Topo'
        });
        
        // Variables globales
        let kmlLayer = L.layerGroup();
        const markers = L.layerGroup().addTo(map);
        
        // --- FUNCI√ìN SIMPLIFICADA PARA PARSEAR KML ---
        function parseKML(kmlText) {
            console.log('Parseando KML...');
            const parser = new DOMParser();
            const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
            
            // Buscar todos los pol√≠gonos
            const polygons = [];
            const placemarks = kmlDoc.getElementsByTagName('Placemark');
            
            console.log('Encontrados', placemarks.length, 'placemarks');
            
            for (let i = 0; i < placemarks.length; i++) {
                const placemark = placemarks[i];
                
                // Obtener nombre
                let name = `Circunscripci√≥n ${i + 1}`;
                const nameElements = placemark.getElementsByTagName('name');
                if (nameElements.length > 0) {
                    name = nameElements[0].textContent;
                }
                
                // Buscar coordenadas en Polygon
                const polygonsElements = placemark.getElementsByTagName('Polygon');
                for (let polyElement of polygonsElements) {
                    const coordElements = polyElement.getElementsByTagName('coordinates');
                    for (let coordElement of coordElements) {
                        const coordsText = coordElement.textContent.trim();
                        const coordsArray = parseCoordinates(coordsText);
                        
                        if (coordsArray.length > 2) {
                            polygons.push({
                                name: name,
                                coordinates: coordsArray
                            });
                        }
                    }
                }
                
                // Buscar tambi√©n en LineString (por si acaso)
                const linesElements = placemark.getElementsByTagName('LineString');
                for (let lineElement of linesElements) {
                    const coordElements = lineElement.getElementsByTagName('coordinates');
                    for (let coordElement of coordElements) {
                        const coordsText = coordElement.textContent.trim();
                        const coordsArray = parseCoordinates(coordsText);
                        
                        if (coordsArray.length > 1) {
                            polygons.push({
                                name: name,
                                coordinates: coordsArray,
                                isLine: true
                            });
                        }
                    }
                }
            }
            
            console.log('Pol√≠gonos parseados:', polygons.length);
            return polygons;
        }
        
        // Funci√≥n auxiliar para parsear coordenadas
        function parseCoordinates(coordsText) {
            const coordinates = [];
            // Separar por espacios o nuevas l√≠neas
            const coordStrings = coordsText.split(/\s+/);
            
            for (let coordStr of coordStrings) {
                if (coordStr.trim() === '') continue;
                
                const parts = coordStr.split(',');
                if (parts.length >= 2) {
                    const lng = parseFloat(parts[0]);
                    const lat = parseFloat(parts[1]);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        coordinates.push([lat, lng]);
                    }
                }
            }
            
            return coordinates;
        }
        
        // --- CARGAR KML ---
        const kmlUrl = 'https://raw.githubusercontent.com/Javiergar900/prueba-topografica/6047b52c13c61d55185b69b85e96e507562fdf6e/circunscripciones.kml';
        
        // Mostrar loader
        document.getElementById('loader').style.display = 'block';
        
        fetch(kmlUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                return response.text();
            })
            .then(kmlText => {
                console.log('KML descargado exitosamente, tama√±o:', kmlText.length, 'bytes');
                
                // Parsear el KML
                const polygons = parseKML(kmlText);
                
                if (polygons.length === 0) {
                    throw new Error('No se encontraron pol√≠gonos en el KML');
                }
                
                // Crear pol√≠gonos en el mapa
                polygons.forEach((polygon, index) => {
                    let layer;
                    
                    if (polygon.isLine) {
                        // Crear l√≠nea
                        layer = L.polyline(polygon.coordinates, {
                            color: '#3498db',
                            weight: 3,
                            opacity: 0.8
                        });
                    } else {
                        // Crear pol√≠gono
                        layer = L.polygon(polygon.coordinates, {
                            className: 'kml-polygon',
                            fillColor: getColorForIndex(index),
                            color: '#2c3e50',
                            weight: 3,
                            opacity: 0.8,
                            fillOpacity: 0.3
                        });
                    }
                    
                    // A√±adir popup y tooltip
                    layer.bindPopup(`<b>${polygon.name}</b>`);
                    layer.bindTooltip(polygon.name, {
                        permanent: false,
                        direction: 'center'
                    });
                    
                    // Efecto hover
                    layer.on('mouseover', function() {
                        if (!polygon.isLine) {
                            this.setStyle({
                                weight: 4,
                                color: '#e74c3c',
                                fillOpacity: 0.5
                            });
                        } else {
                            this.setStyle({
                                weight: 5,
                                color: '#e74c3c'
                            });
                        }
                    });
                    
                    layer.on('mouseout', function() {
                        if (!polygon.isLine) {
                            this.setStyle({
                                weight: 3,
                                color: '#2c3e50',
                                fillOpacity: 0.3
                            });
                        } else {
                            this.setStyle({
                                weight: 3,
                                color: '#3498db'
                            });
                        }
                    });
                    
                    // A√±adir a la capa
                    kmlLayer.addLayer(layer);
                });
                
                // A√±adir capa al mapa
                map.addLayer(kmlLayer);
                
                // Calcular bounds y ajustar vista
                if (kmlLayer.getLayers().length > 0) {
                    const bounds = L.latLngBounds([]);
                    kmlLayer.eachLayer(layer => {
                        if (layer.getBounds) {
                            bounds.extend(layer.getBounds());
                        }
                    });
                    
                    if (bounds.isValid()) {
                        map.fitBounds(bounds.pad(0.1));
                        console.log('Mapa ajustado a bounds:', bounds);
                    }
                }
                
                // Ocultar loader
                document.getElementById('loader').style.display = 'none';
                
                // Mostrar mensaje de √©xito
                L.popup()
                    .setLatLng(map.getCenter())
                    .setContent(`
                        <div style="padding: 10px; text-align: center;">
                            <h4 style="margin: 0 0 10px 0; color: #27ae60;">‚úì KML Cargado</h4>
                            <p>${polygons.length} circunscripciones cargadas</p>
                        </div>
                    `)
                    .openOn(map);
                
                setTimeout(() => map.closePopup(), 2000);
                
            })
            .catch(error => {
                console.error('Error cargando KML:', error);
                
                // Mostrar mensaje de error
                document.getElementById('loader').innerHTML = `
                    <div style="padding: 15px; text-align: center;">
                        <div style="color: #e74c3c; font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <h4 style="margin: 0 0 10px 0; color: #e74c3c;">Error cargando KML</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                            ${error.message}
                        </p>
                        <button onclick="window.location.reload()" style="padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Reintentar
                        </button>
                    </div>
                `;
            });
        
        // Funci√≥n para generar colores
        function getColorForIndex(index) {
            const colors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
            ];
            return colors[index % colors.length];
        }
        
        // --- CONTROL DE CAPAS ---
        const baseMaps = { 
            "Mapa 1": cyclOSM, 
            "Mapa 2": esriTopo 
        };
        
        L.control.layers(baseMaps, overlayMaps, { 
            collapsed: true,
            position: 'topright'
        }).addTo(map);
        
        // --- L√ìGICA DE EVENTOS ---
        function saveEvent(lat, lng) {
            const tipo = document.getElementById('tipo').value;
            const obs = document.getElementById('obs').value;
            const hora = document.getElementById('hora').value;

            // Crear marcador
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: #e74c3c; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);">!</div>`
                })
            }).addTo(markers);
            
            marker.bindPopup(`
                <div style="max-width: 250px;">
                    <b style="color: #e74c3c;">${tipo}</b><br>
                    <small>Hora: ${hora}</small><br>
                    <small>Coords: ${lat.toFixed(4)}, ${lng.toFixed(4)}</small>
                    <hr style="margin: 5px 0;">
                    <div style="font-size: 12px;">${obs || 'Sin observaciones'}</div>
                    <div style="font-size: 10px; color: #666; margin-top: 5px;">
                        ${new Date().toLocaleDateString()}
                    </div>
                </div>
            `).openPopup();
            
            console.log('Evento guardado:', { lat, lng, tipo, hora, obs });
            map.closePopup();
        }
        
        // Manejar clics en el mapa
        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });

            const formHtml = `
                <div class="form-container">
                    <h3 style="margin:0 0 10px 0; color:#2c3e50;">Nuevo Reporte</h3>
                    <div style="font-size: 11px; color: #666; margin-bottom: 10px;">
                        ${lat.toFixed(6)}, ${lng.toFixed(6)}
                    </div>
                    
                    <label>Tipolog√≠a</label>
                    <select id="tipo">
                        <option value="Robo/Hurto">Robo/Hurto</option>
                        <option value="Presencia Sospechosa">Presencia Sospechosa</option>
                        <option value="Abigeato">Abigeato (Ganado)</option>
                        <option value="Vandalismo">Vandalismo</option>
                        <option value="Otro">Otro</option>
                    </select>

                    <label>Hora del evento</label>
                    <input type="time" id="hora" value="${timeString}">

                    <label>Observaciones</label>
                    <textarea id="obs" rows="3" placeholder="Descripci√≥n del evento..."></textarea>

                    <button class="btn-save" onclick="saveEvent(${lat}, ${lng})">GUARDAR EVENTO</button>
                </div>
            `;

            L.popup()
                .setLatLng([lat, lng])
                .setContent(formHtml)
                .openOn(map);
        });
        
        // --- CONTROLES PERSONALIZADOS ---
        // Control para limpiar marcadores
        const clearControl = L.control({position: 'bottomright'});
        clearControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-control-custom');
            
            L.DomEvent.on(div, 'click', function(e) {
                L.DomEvent.stopPropagation(e);
                if (markers.getLayers().length > 0) {
                    if (confirm('¬øEliminar todos los marcadores de eventos?')) {
                        markers.clearLayers();
                    }
                }
            });
            
            return div;
        };
        clearControl.addTo(map);
        
        // Control para recargar
        const reloadControl = L.control({position: 'bottomright'});
        reloadControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-control-custom');
            div.innerHTML = '<a href="#" title="Recargar todo">üîÑ Recargar</a>';
            
            L.DomEvent.on(div, 'click', function(e) {
                L.DomEvent.stopPropagation(e);
                window.location.reload();
            });
            
            return div;
        };
        reloadControl.addTo(map);
        
        // Control para mostrar/ocultar KML
        const toggleKmlControl = L.control({position: 'bottomright'});
        toggleKmlControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-control-custom');
            div.innerHTML = '<a href="#" title="Mostrar/ocultar circunscripciones">üó∫Ô∏è Circunscripciones</a>';
            
            L.DomEvent.on(div, 'click', function(e) {
                L.DomEvent.stopPropagation(e);
                if (map.hasLayer(kmlLayer)) {
                    map.removeLayer(kmlLayer);
                    div.innerHTML = '<a href="#" title="Mostrar circunscripciones">üó∫Ô∏è Mostrar</a>';
                } else {
                    map.addLayer(kmlLayer);
                    div.innerHTML = '<a href="#" title="Ocultar circunscripciones">üó∫Ô∏è Ocultar</a>';
                }
            });
            
            return div;
        };
        toggleKmlControl.addTo(map);
        
        // Hacer funciones globales
        window.saveEvent = saveEvent;

    </script>
</body>
</html>

